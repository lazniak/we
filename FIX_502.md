# Fix 502 Bad Gateway

## Problem
Nginx returns 502 Bad Gateway - applications are not responding.

## Diagnostic Commands

Run these on the VPS:

```bash
# 1. Check PM2 status
pm2 status

# 2. Check PM2 logs for errors
pm2 logs --lines 50

# 3. Check if ports are listening
netstat -tlnp | grep -E ':(3000|3001)'

# 4. Check Nginx error logs
tail -50 /var/log/nginx/error.log

# 5. Check if Bun is in PATH for PM2
which bun
echo $PATH
```

## Common Issues & Fixes

### Issue 1: Bun not found in PM2 environment

PM2 might not have Bun in PATH. Fix:

```bash
# Edit ecosystem.config.js
cd /var/www/we
nano ecosystem.config.js
```

Add PATH to env:
```javascript
env: {
  NODE_ENV: 'production',
  PORT: 3001,
  PATH: '/root/.bun/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin',
},
```

Then restart:
```bash
pm2 restart all
```

### Issue 2: Bun needs full path

Update ecosystem.config.js:
```javascript
{
  name: 'we-backend',
  cwd: '/var/www/we/backend',
  script: '/root/.bun/bin/bun',
  args: 'run start',
  interpreter: 'none',
  ...
}
```

### Issue 3: Check backend logs

```bash
pm2 logs we-backend --lines 100
```

### Issue 4: Test backend directly

```bash
cd /var/www/we/backend
source /root/.bashrc
bun run start
```

If it works, the issue is with PM2 configuration.

## Quick Fix Script

```bash
cd /var/www/we

# Update ecosystem.config.js with full Bun path
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'we-backend',
      cwd: '/var/www/we/backend',
      script: '/root/.bun/bin/bun',
      args: 'run start',
      interpreter: 'none',
      env: {
        NODE_ENV: 'production',
        PORT: 3001,
        PATH: '/root/.bun/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin',
      },
      error_file: '/var/www/we/logs/backend-error.log',
      out_file: '/var/www/we/logs/backend-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
      autorestart: true,
      max_memory_restart: '500M',
    },
    {
      name: 'we-frontend',
      cwd: '/var/www/we/frontend',
      script: 'npm',
      args: 'run start',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
        PATH: '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin',
      },
      error_file: '/var/www/we/logs/frontend-error.log',
      out_file: '/var/www/we/logs/frontend-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
      autorestart: true,
      max_memory_restart: '300M',
    },
  ],
};
EOF

# Restart PM2
pm2 delete all
pm2 start ecosystem.config.js
pm2 save

# Check status
pm2 status
pm2 logs --lines 20
```
